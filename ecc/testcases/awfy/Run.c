// Generated by Oberon+ IDE (Mono) 0.9.106 on 2024-07-13T01:26:30

#include "Run.h"

void Run$Run$init$(struct Run$Run* inst){
    inst->class$ = &Run$Run$class$;
}
struct Run$Run * Run$create(struct OBX$Array$1 name) {
    struct Run$Run * r;
    struct Run$Run * $t0;
    r = 0;
    $t0 = OBX$Alloc(sizeof(struct Run$Run));
    memset($t0,0,sizeof(struct Run$Run));
    r = $t0;
    Run$Run$init$($t0);
    OBX$StrCopy(&(struct OBX$Array$1){32,1,(*r).name},0,&name,0);
    (*r).numIterations = 1;
    (*r).innerIterations = 1;
    (*r).total = 0;
    (*r).benchmarkSuite = Run$getSuiteFromName(name);
    return r;
}

struct Benchmark$Benchmark * Run$getSuiteFromName(struct OBX$Array$1 name) {
    if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){8,0,OBX$FromUtf("Permute",8,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Permute$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){7,0,OBX$FromUtf("Bounce",7,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Bounce$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){5,0,OBX$FromUtf("List",5,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)List$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){11,0,OBX$FromUtf("Mandelbrot",11,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Mandelbrot$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){7,0,OBX$FromUtf("Queens",7,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Queens$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){6,0,OBX$FromUtf("Sieve",6,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Sieve$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){8,0,OBX$FromUtf("Storage",8,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Storage$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){7,0,OBX$FromUtf("Towers",7,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Towers$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){9,0,OBX$FromUtf("Richards",9,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Richards$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){5,0,OBX$FromUtf("Json",5,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Json$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){6,0,OBX$FromUtf("NBody",6,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)NBody$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){4,0,OBX$FromUtf("CD2",4,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)CD2$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){3,0,OBX$FromUtf("CD",3,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)CD$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){7,0,OBX$FromUtf("Havlak",7,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)Havlak$create());
    } else if( OBX$StrOp(&name,0,&(const struct OBX$Array$1){10,0,OBX$FromUtf("DeltaBlue",10,0)},0,1) ) {
        return ((struct Benchmark$Benchmark *)DeltaBlue$create());
    } 
    return 0;
}

void Run$Run$runBenchmark(void* this) {
    struct Run$Run* this$ = this;
    void* $t0;
    uint8_t (* $t1)(void*, struct Benchmark$Benchmark *);
    void (* $t2)(void*);
    Out$String((const struct OBX$Array$1){10,0,OBX$FromUtf("Starting ",10,0)});
    Out$String((struct OBX$Array$1){32,1,(*this$).name});
    Out$String((const struct OBX$Array$1){15,0,OBX$FromUtf(" benchmark ...",15,0)});
    Out$Ln();
    if( ((void*)(*this$).benchmarkSuite == (void*)0) ) {
        Out$String((const struct OBX$Array$1){25,0,OBX$FromUtf("ERROR unknown benchmark ",25,0)});
        Out$String((struct OBX$Array$1){32,1,(*this$).name});
        Out$Ln();
        return ;
    } 
    if( (!($t1 = ((struct Run$Run *)($t0 = &(*this$)))->class$->doRuns, $t1($t0, (*this$).benchmarkSuite))) ) {
        Out$String((const struct OBX$Array$1){6,0,OBX$FromUtf("ERROR",6,0)});
        Out$Ln();
        return ;
    } 
    ($t2 = ((struct Run$Run *)($t0 = &(*this$)))->class$->reportBenchmark, $t2($t0));
    Out$Ln();
}

uint8_t Run$Run$doRuns(void* this, struct Benchmark$Benchmark * bench) {
    struct Run$Run* this$ = this;
    int32_t i;
    void* $t0;
    uint8_t (* $t1)(void*, struct Benchmark$Benchmark *);
    i = 0;
    i = 0;
    while(1) {
        if( (i <= ((*this$).numIterations - 1)) ) {
            if( (!($t1 = ((struct Run$Run *)($t0 = &(*this$)))->class$->measure, $t1($t0, bench))) ) {
                return 0;
            } 
            i = (i + 1);
        } else {
            break;
        }
    }
    return 1;
}

uint8_t Run$Run$measure(void* this, struct Benchmark$Benchmark * bench) {
    struct Run$Run* this$ = this;
    int32_t startTime;
    int32_t endTime;
    int32_t runTime;
    void* $t0;
    uint8_t (* $t1)(void*, int32_t);
    void (* $t2)(void*, int32_t);
    startTime = 0;
    endTime = 0;
    runTime = 0;
    startTime = Input$Time();
    if( (!($t1 = ((struct Benchmark$Benchmark *)($t0 = &(*bench)))->class$->innerBenchmarkLoop, $t1($t0, (*this$).innerIterations))) ) {
        return 0;
    } 
    endTime = Input$Time();
    runTime = (endTime - startTime);
    ($t2 = ((struct Run$Run *)($t0 = &(*this$)))->class$->printResult, $t2($t0, runTime));
    (*this$).total = ((*this$).total + runTime);
    return 1;
}

void Run$Run$reportBenchmark(void* this) {
    struct Run$Run* this$ = this;
    Out$String((struct OBX$Array$1){32,1,(*this$).name});
    Out$String((const struct OBX$Array$1){14,0,OBX$FromUtf(": iterations=",14,0)});
    Out$Int((*this$).numIterations, 0);
    Out$String((const struct OBX$Array$1){11,0,OBX$FromUtf(" average: ",11,0)});
    Out$Int(OBX$Div32((*this$).total,(*this$).numIterations), 0);
    Out$String((const struct OBX$Array$1){11,0,OBX$FromUtf("us total: ",11,0)});
    Out$Int((*this$).total, 0);
    Out$String((const struct OBX$Array$1){3,0,OBX$FromUtf("us",3,0)});
    Out$Ln();
}

void Run$Run$printResult(void* this, int32_t runTime) {
    struct Run$Run* this$ = this;
    return ;
    Out$String((struct OBX$Array$1){32,1,(*this$).name});
    Out$String((const struct OBX$Array$1){25,0,OBX$FromUtf(": iterations=1 runtime: ",25,0)});
    Out$Int(runTime, 0);
    Out$String((const struct OBX$Array$1){3,0,OBX$FromUtf("us",3,0)});
    Out$Ln();
}

void Run$Run$printTotal(void* this) {
    struct Run$Run* this$ = this;
    return ;
    Out$String((const struct OBX$Array$1){16,0,OBX$FromUtf("Total Runtime: ",16,0)});
    Out$Int((*this$).total, 0);
    Out$String((const struct OBX$Array$1){3,0,OBX$FromUtf("us",3,0)});
    Out$Ln();
}

void Run$Run$setNumIterations(void* this, int32_t numIterations) {
    struct Run$Run* this$ = this;
    (*this$).numIterations = numIterations;
}

void Run$Run$setInnerIterations(void* this, int32_t innerIterations) {
    struct Run$Run* this$ = this;
    (*this$).innerIterations = innerIterations;
}

struct Run$Run$Class$ Run$Run$class$ = { 
    0,
    Run$Run$runBenchmark,
    Run$Run$doRuns,
    Run$Run$measure,
    Run$Run$reportBenchmark,
    Run$Run$printResult,
    Run$Run$printTotal,
    Run$Run$setNumIterations,
    Run$Run$setInnerIterations,
};

static int initDone$ = 0;
void Run$init$(void) {
    if(initDone$) return; else initDone$ = 1;
    Benchmark$init$();
    Out$init$();
    Input$init$();
    Permute$init$();
    Bounce$init$();
    List$init$();
    Mandelbrot$init$();
    Queens$init$();
    Sieve$init$();
    Storage$init$();
    Towers$init$();
    Richards$init$();
    Json$init$();
    NBody$init$();
    CD$init$();
    CD2$init$();
    Havlak$init$();
    DeltaBlue$init$();
}
OBX$Cmd Run$cmd$(const char* name) {
    if( name == 0 ) return Run$init$;
    return 0;
}
